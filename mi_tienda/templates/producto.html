<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ producto.name }} | Tienda Abarrotes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_producto.css') }}">
</head>
<body>
  <header>
    <nav>
      <a href="{{ url_for('index') }}">Inicio</a>
      <a href="{{ url_for('view_cart') }}">Carrito</a>
      <a href="{{ url_for('contacto') }}">Contacto</a>
    </nav>
  </header>
  <main>
    <section class="producto-detalle">
      <div class="producto-imagen">
        {% if producto.supplier and producto.image %}
          <img src="{{ url_for('static', filename='img/' ~ producto.supplier ~ '/' ~ producto.image) }}" alt="{{ producto.name }}" tabindex="0">
        {% else %}
          <img src="{{ url_for('static', filename='img/no_image.jpg') }}" alt="Sin imagen" tabindex="0">
        {% endif %}
      </div>
      <div class="producto-info">
        <h1>{{ producto.name }}</h1>
        <p class="producto-brand">{{ producto.brand }} | {{ producto.weight }}</p>
        <p class="producto-price">${{ producto.price_display() }}</p>
        <p class="producto-stock">
          {% if producto.stock > 0 %}
            <span class="stock-ok">Disponible: {{ producto.stock }}</span>
          {% else %}
            <span class="stock-no">Sin stock</span>
          {% endif %}
        </p>
        <form action="{{ url_for('route_add_to_cart') }}" method="POST" class="add-to-cart-form">
          <input type="hidden" name="product_id" value="{{ producto.id }}">
          <label for="cantidad-input" class="sr-only">Cantidad</label>
          <input 
            type="number" 
            id="cantidad-input" 
            name="cantidad" 
            value="1" 
            min="1" 
            max="{{ producto.stock }}" 
            required 
            placeholder="Cantidad"
            title="Cantidad a agregar"
          >
          <button 
            type="submit" 
            {% if producto.stock == 0 %}disabled{% endif %}
            title="Agregar al carrito"
          >Agregar al carrito</button>
        </form>
        <!-- Pestañas de detalles -->
        <div class="producto-tabs">
          <button type="button" class="tab-btn active" data-tab="descripcion">Descripción</button>
          <button type="button" class="tab-btn" data-tab="ingredientes">Ingredientes</button>
          <button type="button" class="tab-btn" data-tab="alergenos">Alérgenos</button>
          <button type="button" class="tab-btn" data-tab="nutricional">Info Nutricional</button>
        </div>
        <div class="tab-content" id="descripcion">
          <h2>Descripción</h2>
          <p>{{ producto.description }}</p>
        </div>
        <div class="tab-content" id="ingredientes" style="display:none;">
          <h2>Ingredientes</h2>
          <p>{{ producto.ingredients }}</p>
        </div>
        <div class="tab-content" id="alergenos" style="display:none;">
          <h2>Alérgenos</h2>
          <p>{{ producto.allergens }}</p>
        </div>
        <div class="tab-content" id="nutricional" style="display:none;">
          <h2>Información nutricional</h2>
          <p>{{ producto.nutritional_info }}</p>
        </div>
      </div>
    </section>
    <a href="{{ url_for('index') }}" class="btn-volver">Volver a la tienda</a>
  </main>
  <!-- Modal para imagen ampliada -->
  <div id="modal-img" class="modal-img" style="display:none;" aria-modal="true" role="dialog">
    <span class="close-modal" id="close-modal" tabindex="0" aria-label="Cerrar imagen ampliada">&times;</span>
    {% if producto.supplier and producto.image %}
      <img id="modal-product-img" src="{{ url_for('static', filename='img/' ~ producto.supplier ~ '/' ~ producto.image) }}" alt="{{ producto.name }}">
    {% else %}
      <img id="modal-product-img" src="{{ url_for('static', filename='img/no_image.jpg') }}" alt="Sin imagen">
    {% endif %}
  </div>
  <div class="user-auth-box">
    <button type="button" class="user-auth-btn" id="join-btn">Join</button>
  </div>
  <!-- Modal de login -->
  <div id="login-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-modal" id="close-login-modal">&times;</span>
      <h2>Login</h2>
      <form id="login-form">
        <label for="login-username">Username</label>
        <input type="text" id="login-username" name="username" required value="exael">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" name="password" required value="exael">
        <button type="submit" class="nav-btn">Login</button>
        <div id="login-error" style="color:#e74c3c; margin-top:0.5em; display:none;">Invalid credentials</div>
      </form>
    </div>
  </div>
  <!-- Modal de bienvenida -->
  <div id="welcome-modal" class="modal" style="display:none;">
    <div class="welcome-content">
      <div class="welcome-circle welcome-circle-green">
        <svg width="60" height="60">
          <circle cx="30" cy="30" r="28" />
          <polyline points="18,32 28,42 44,22" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="welcome-text welcome-text-green">Welcome, <span id="welcome-username">exael</span>!</div>
    </div>
  </div>
  <!-- Modal de logout -->
  <div id="goodbye-modal" class="modal" style="display:none;">
    <div class="welcome-content">
      <div class="welcome-circle welcome-circle-red">
        <svg width="60" height="60">
          <circle cx="30" cy="30" r="28" />
          <polyline points="18,32 28,42 44,22" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="welcome-text welcome-text-red">Esperamos su regreso</div>
    </div>
  </div>
  <footer class="main-footer">
    <div class="footer-content">
      <img src="{{ url_for('static', filename='img/banner.jpg') }}" alt="Tienda Abarrotes" class="footer-logo">
      <div>
        <p>&copy; {{ now.year }} Tienda Abarrotes. Todos los derechos reservados.</p>
        <p>
          Este sitio es un proyecto educativo inspirado en tiendas oficiales como 
          <a href="https://www.bimbo.com.mx/" target="_blank" rel="noopener">Bimbo</a>, 
          <a href="https://www.gamesa.com.mx/" target="_blank" rel="noopener">Gamesa</a> y 
          <a href="https://www.sabritas.com.mx/" target="_blank" rel="noopener">Sabritas</a>.
        </p>
        <p>
          Contacto: <a href="mailto:info@mitienda.com">info@mitienda.com</a> | 
          <a href="{{ url_for('contacto') }}">Contacto</a>
        </p>
      </div>
    </div>
  </footer>
  <script>
if (document.getElementById('join-btn')) {
  document.getElementById('join-btn').onclick = function() {
    document.getElementById('login-modal').style.display = 'block';
  };
}
if (document.getElementById('close-login-modal')) {
  document.getElementById('close-login-modal').onclick = function() {
    document.getElementById('login-modal').style.display = 'none';
    document.getElementById('login-error').style.display = 'none';
  };
}
window.onclick = function(event) {
  if (event.target == document.getElementById('login-modal')) {
    document.getElementById('login-modal').style.display = 'none';
    document.getElementById('login-error').style.display = 'none';
  }
};
if (document.getElementById('login-form')) {
  document.getElementById('login-form').onsubmit = function(e) {
    e.preventDefault();
    const user = document.getElementById('login-username').value;
    const pass = document.getElementById('login-password').value;
    if (user === 'exael' && pass === 'exael') {
      sessionStorage.setItem('usuario', user);
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('welcome-username').textContent = user;
      document.getElementById('welcome-modal').style.display = 'block';
      setTimeout(function() {
        document.getElementById('welcome-modal').style.display = 'none';
        mostrarUsuario(user);
      }, 1800);
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  };
}

function mostrarUsuario(user) {
  var userBox = document.querySelector('.user-auth-box');
  if (userBox) {
    userBox.innerHTML = `
      <span class="user-auth-name" id="user-auth-name">${user}</span>
      <div class="user-auth-menu" id="user-auth-menu">
        <button type="button" id="logout-btn">Logout</button>
      </div>
    `;
    var userNameBtn = document.getElementById('user-auth-name');
    var userMenu = document.getElementById('user-auth-menu');
    userNameBtn.onclick = function(e) {
      e.stopPropagation();
      userMenu.classList.toggle('show');
      userNameBtn.classList.toggle('active');
    };
    document.addEventListener('click', function() {
      userMenu.classList.remove('show');
      userNameBtn.classList.remove('active');
    });
    document.getElementById('logout-btn').onclick = function() {
      document.getElementById('goodbye-modal').style.display = 'block';
      setTimeout(function() {
        document.getElementById('goodbye-modal').style.display = 'none';
        sessionStorage.removeItem('usuario');
        userBox.innerHTML = '<button type="button" class="user-auth-btn" id="join-btn">Join</button>';
        document.getElementById('join-btn').onclick = function() {
          document.getElementById('login-modal').style.display = 'block';
        };
      }, 1800);
    };
  }
}

document.addEventListener('DOMContentLoaded', function() {
  var usuarioGuardado = sessionStorage.getItem('usuario');
  if (usuarioGuardado) {
    mostrarUsuario(usuarioGuardado);
  }
});
    document.addEventListener('DOMContentLoaded', function() {
      // Tabs JS
      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
          var tab = document.getElementById(btn.dataset.tab);
          if(tab) tab.style.display = 'block';
        });
      });

      // Modal imagen ampliada
      var img = document.querySelector('.producto-imagen img');
      var modal = document.getElementById('modal-img');
      var closeBtn = document.getElementById('close-modal');
      if(img && modal && closeBtn) {
        img.addEventListener('click', function() {
          modal.style.display = 'flex';
        });
        closeBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });
        // Cerrar modal al hacer click fuera de la imagen
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
        // Accesibilidad: cerrar con tecla ESC
        document.addEventListener('keydown', function(e) {
          if (modal.style.display === 'flex' && (e.key === 'Escape' || e.key === 'Esc')) {
            modal.style.display = 'none';
          }
        });
      }

      // User auth modals
      var joinBtn = document.getElementById('join-btn');
      var loginModal = document.getElementById('login-modal');
      var closeLoginModal = document.getElementById('close-login-modal');
      var welcomeModal = document.getElementById('welcome-modal');
      var goodbyeModal = document.getElementById('goodbye-modal');

      if(joinBtn && loginModal && closeLoginModal) {
        joinBtn.addEventListener('click', function() {
          loginModal.style.display = 'flex';
        });
        closeLoginModal.addEventListener('click', function() {
          loginModal.style.display = 'none';
        });
        // Cerrar modal de login al hacer click fuera del contenido
        loginModal.addEventListener('click', function(e) {
          if (e.target === loginModal) {
            loginModal.style.display = 'none';
          }
        });
        // Simular login exitoso
        document.getElementById('login-form').addEventListener('submit', function(e) {
          e.preventDefault();
          var username = document.getElementById('login-username').value;
          // Aquí podrías agregar la lógica de autenticación real
          document.getElementById('welcome-username').innerText = username;
          loginModal.style.display = 'none';
          welcomeModal.style.display = 'flex';
        });
      }

      // Cerrar modal de bienvenida y mostrar modal de despedida al recargar
      window.addEventListener('beforeunload', function() {
        if (welcomeModal.style.display === 'flex') {
          welcomeModal.style.display = 'none';
          goodbyeModal.style.display = 'flex';
        }
      });
      var closeGoodbyeModal = document.getElementById('close-goodbye-modal');
      if(closeGoodbyeModal) {
        closeGoodbyeModal.addEventListener('click', function() {
          goodbyeModal.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>