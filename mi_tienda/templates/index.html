<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tienda Abarrotes con Flask Stripe</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <!-- SwiperJS CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
</head>
<body>
  <header class="main-header">
    <div class="banner-container">
      <img src="{{ url_for('static', filename='img/banner.jpg') }}" alt="Tienda Abarrotes" class="banner-img">
      <nav class="main-nav">
        <!-- <a href="{{ url_for('index') }}" class="nav-btn">Inicio</a> -->
        <a href="{{ url_for('view_cart') }}" class="nav-btn">Carrito</a>
        <a href="{{ url_for('contacto') }}" class="nav-btn">Contacto</a>
      </nav>
    </div>
  </header>
  <main class="main-content">
    {% for proveedor, productos in products_by_supplier.items() %}
      <section>
        <h2>{{ proveedor }}</h2>
        <div class="swiper">
          <div class="swiper-wrapper">
            {% for producto in productos %}
              <div class="swiper-slide">
                <div class="producto-card">
                  <a href="{{ url_for('producto_detalle', product_id=producto.id) }}">
                    {% if producto.supplier and producto.image %}
                      <img src="{{ url_for('static', filename='img/' ~ producto.supplier ~ '/' ~ producto.image) }}" alt="{{ producto.name }}" class="producto-img">
                    {% else %}
                      <img src="{{ url_for('static', filename='img/no_image.jpg') }}" alt="Sin imagen" class="producto-img">
                    {% endif %}
                    <h3>{{ producto.name }}</h3>
                  </a>
                  <p>${{ producto.price_display() }}</p>
                  <form action="{{ url_for('route_add_to_cart') }}" method="POST" class="add-to-cart-form">
                    <label for="cantidad-{{ producto.id }}" class="visually-hidden">Cantidad</label>
                    <input type="hidden" name="product_id" value="{{ producto.id }}">
                    <input type="number" id="cantidad-{{ producto.id }}" name="cantidad" value="1" min="1" max="10" required placeholder="Cantidad" title="Cantidad a agregar">
                    <button type="submit">Agregar al carrito</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          <!-- Swiper navigation buttons -->
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
          <div class="swiper-pagination"></div>
        </div>
      </section>
    {% endfor %}
  </main>
  <footer class="main-footer">
    <div class="footer-content">
      <img src="{{ url_for('static', filename='img/banner.jpg') }}" alt="Tienda Abarrotes" class="footer-logo">
      <div>
        <p>&copy; {{ now.year }} Tienda Abarrotes. Todos los derechos reservados.</p>
        <p>
          Este sitio es un proyecto educativo inspirado en tiendas oficiales como 
          <a href="https://www.bimbo.com.mx/" target="_blank" rel="noopener">Bimbo</a>, 
          <a href="https://www.gamesa.com.mx/" target="_blank" rel="noopener">Gamesa</a> y 
          <a href="https://www.sabritas.com.mx/" target="_blank" rel="noopener">Sabritas</a>.
        </p>
        <p>
          Contacto: <a href="mailto:info@mitienda.com">info@mitienda.com</a> | 
          <a href="{{ url_for('contacto') }}">Contacto</a>
        </p>
      </div>
    </div>
  </footer>
  <!-- SwiperJS JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
  document.querySelectorAll('.swiper').forEach(function(swiperEl) {
    new Swiper(swiperEl, {
      slidesPerView: 'auto',
      spaceBetween: 20,
      navigation: {
        nextEl: swiperEl.querySelector('.swiper-button-next'),
        prevEl: swiperEl.querySelector('.swiper-button-prev'),
      },
      pagination: {
        el: swiperEl.querySelector('.swiper-pagination'),
        clickable: true,
      },
      breakpoints: {
        1200: { slidesPerView: 'auto', spaceBetween: 24 },
        800: { slidesPerView: 'auto', spaceBetween: 18 },
        500: { slidesPerView: 1, spaceBetween: 8 }
      }
    });
  });
  </script>
  {% if rol %}
    <div class="user-role">
      Rol: <strong>{{ rol|capitalize }}</strong>
    </div>
  {% endif %}
  <div class="user-auth-box">
    {% if usuario %}
      <span class="user-auth-name">{{ usuario }}</span>
    {% else %}
      <button type="button" class="user-auth-btn" id="join-btn">Join</button>
    {% endif %}
  </div>
  <div id="login-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-modal" id="close-login-modal">&times;</span>
      <h2>Login</h2>
      <form id="login-form">
        <label for="login-username">Username</label>
        <input type="text" id="login-username" name="username" required value="exael">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" name="password" required value="exael">
        <button type="submit" class="nav-btn">Login</button>
        <div id="login-error" style="color:#e74c3c; margin-top:0.5em; display:none;">Invalid credentials</div>
      </form>
    </div>
  </div>

  <!-- Modal de bienvenida -->
  <div id="welcome-modal" class="modal" style="display:none;">
    <div class="welcome-content">
      <div class="welcome-circle welcome-circle-green">
        <svg width="60" height="60">
          <circle cx="30" cy="30" r="28" />
          <polyline points="18,32 28,42 44,22" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="welcome-text welcome-text-green">Welcome, <span id="welcome-username">exael</span>!</div>
    </div>
  </div>

  <!-- Modal de logout -->
  <div id="goodbye-modal" class="modal" style="display:none;">
    <div class="welcome-content">
      <div class="welcome-circle welcome-circle-red">
        <svg width="60" height="60">
          <circle cx="30" cy="30" r="28" />
          <polyline points="18,32 28,42 44,22" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="welcome-text welcome-text-red">Esperamos su regreso</div>
    </div>
  </div>
  <script>
  document.getElementById('join-btn').onclick = function() {
    document.getElementById('login-modal').style.display = 'block';
  };
  document.getElementById('close-login-modal').onclick = function() {
    document.getElementById('login-modal').style.display = 'none';
    document.getElementById('login-error').style.display = 'none';
  };
  window.onclick = function(event) {
    if (event.target == document.getElementById('login-modal')) {
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('login-error').style.display = 'none';
    }
  };
  document.getElementById('login-form').onsubmit = function(e) {
    e.preventDefault();
    const user = document.getElementById('login-username').value;
    const pass = document.getElementById('login-password').value;
    if (user === 'exael' && pass === 'exael') {
      sessionStorage.setItem('usuario', user); // <-- Cambiado aquí
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('welcome-username').textContent = user;
      document.getElementById('welcome-modal').style.display = 'block';
      setTimeout(function() {
        document.getElementById('welcome-modal').style.display = 'none';
        mostrarUsuario(user); // <-- Usa una función para mostrar el usuario
      }, 1800);
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  };

  function mostrarUsuario(user) {
    var userBox = document.querySelector('.user-auth-box');
    if (userBox) {
      userBox.innerHTML = `
        <span class="user-auth-name" id="user-auth-name">${user}</span>
        <div class="user-auth-menu" id="user-auth-menu">
          <button type="button" id="logout-btn">Logout</button>
        </div>
      `;
      // Mostrar/ocultar menú al hacer click en el nombre
      var userNameBtn = document.getElementById('user-auth-name');
      var userMenu = document.getElementById('user-auth-menu');
      userNameBtn.onclick = function(e) {
        e.stopPropagation();
        userMenu.classList.toggle('show');
        userNameBtn.classList.toggle('active');
      };
      document.addEventListener('click', function() {
        userMenu.classList.remove('show');
        userNameBtn.classList.remove('active');
      });
      // Logout
      document.getElementById('logout-btn').onclick = function() {
        document.getElementById('goodbye-modal').style.display = 'block';
        setTimeout(function() {
          document.getElementById('goodbye-modal').style.display = 'none';
          sessionStorage.removeItem('usuario'); // <-- Cambiado aquí
          userBox.innerHTML = '<button type="button" class="user-auth-btn" id="join-btn">Join</button>';
          document.getElementById('join-btn').onclick = function() {
            document.getElementById('login-modal').style.display = 'block';
          };
        }, 1800);
      };
    }
  }

  // Al cargar la página, revisa si hay usuario guardado
  document.addEventListener('DOMContentLoaded', function() {
    var usuarioGuardado = sessionStorage.getItem('usuario'); // <-- Cambiado aquí
    if (usuarioGuardado) {
      mostrarUsuario(usuarioGuardado);
    }
  });
  </script>
</body>
</html>